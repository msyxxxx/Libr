<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>منصة التعليم المباشر</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #007bff;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      padding: 1rem;
    }
    #stream-section {
      text-align: center;
    }
    #live-stream {
      width: 80%;
      max-width: 600px;
      border: 2px solid #007bff;
      border-radius: 8px;
    }
    #controls button {
      margin: 0.5rem;
    }
    #interaction-section ul,
    #current-streams ul {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>منصة التعليم المباشر</h1>
  </header>
  <main>
    <section id="stream-section">
      <video id="live-stream" autoplay muted></video>
      <div id="controls">
        <input type="text" id="admin-key" placeholder="أدخل مفتاح المشرف">
        <button id="start-stream">بدء البث</button>
        <button id="stop-stream">إيقاف البث</button>
      </div>
    </section>
    <section id="interaction-section">
      <h2>التفاعل</h2>
      <button id="raise-hand">رفع اليد</button>
      <ul id="hands-list"></ul>
    </section>
    <section id="current-streams">
      <h2>البثوص الحالية</h2>
      <ul id="streams-list"></ul>
    </section>
  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // عناصر الصفحة
    const liveStream = document.getElementById('live-stream');
    const startStreamBtn = document.getElementById('start-stream');
    const stopStreamBtn = document.getElementById('stop-stream');
    const raiseHandBtn = document.getElementById('raise-hand');
    const adminKeyInput = document.getElementById('admin-key');
    const handsList = document.getElementById('hands-list');
    const streamsList = document.getElementById('streams-list');

    const ADMIN_KEY = "12345"; // مفتاح المشرف الثابت

    // التحكم بالبث
    let mediaStream;
    startStreamBtn.addEventListener('click', async () => {
      if (adminKeyInput.value !== ADMIN_KEY) {
        alert("مفتاح المشرف غير صحيح!");
        return;
      }

      mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      liveStream.srcObject = mediaStream;

      // إرسال البث للسيرفر
      socket.emit('start-stream', 'بث مباشر جديد');
    });

    stopStreamBtn.addEventListener('click', () => {
      if (adminKeyInput.value !== ADMIN_KEY) {
        alert("مفتاح المشرف غير صحيح!");
        return;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        socket.emit('stop-stream');
      }
    });

    // رفع اليد
    raiseHandBtn.addEventListener('click', () => {
      socket.emit('raise-hand', 'طالب رفع اليد');
    });

    // استقبال التحديثات
    socket.on('update-hands', hands => {
      handsList.innerHTML = '';
      hands.forEach(hand => {
        const li = document.createElement('li');
        li.textContent = hand;
        handsList.appendChild(li);
      });
    });

    socket.on('update-streams', streams => {
      streamsList.innerHTML = '';
      streams.forEach(stream => {
        const li = document.createElement('li');
        li.textContent = stream;
        streamsList.appendChild(li);
      });
    });
  </script>
</body>
</html>

<!-- server.js -->
<script type="module">
  import express from "express";
  import { createServer } from "http";
  import { Server } from "socket.io";

  const app = express();
  const server = createServer(app);
  const io = new Server(server);

  let hands = [];
  let streams = [];

  app.use(express.static("."));

  io.on("connection", (socket) => {
    console.log("مستخدم متصل");

    socket.on("start-stream", (streamName) => {
      streams.push(streamName);
      io.emit("update-streams", streams);
    });

    socket.on("stop-stream", () => {
      streams = [];
      io.emit("update-streams", streams);
    });

    socket.on("raise-hand", (hand) => {
      hands.push(hand);
      io.emit("update-hands", hands);
    });

    socket.on("disconnect", () => {
      console.log("مستخدم غادر");
    });
  });

  server.listen(3000, () => {
    console.log("الخادم يعمل على المنفذ 3000");
  });
</script>
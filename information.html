<script>
  const data = JSON.parse(localStorage.getItem("personsData")) || [];

  function renderTable() {
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    data.forEach((person, index) => {
      const row = `
        <tr>
          <td>${index + 1}</td>
          <td>${person.name}</td>
          <td>${person.phone}</td>
          <td>${person.id}</td>
          <td><button style="color: red;" onclick="deletePerson(${index})">❌</button></td>
        </tr>`;
      tableBody.innerHTML += row;
    });

    localStorage.setItem("personsData", JSON.stringify(data));
  }

  function addPerson() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const id = document.getElementById("id").value.trim();

    if (!name || !phone || !id) {
      alert("يرجى ملء جميع الحقول!");
      return;
    }

    data.push({ name, phone, id });
    renderTable();
    document.getElementById("personForm").reset();
  }

  function deletePerson(index) {
    data.splice(index, 1);
    renderTable();
  }

  function clearAll() {
    if (confirm("هل أنت متأكد من حذف جميع البيانات؟")) {
      data.length = 0;
      renderTable();
    }
  }

  function downloadExcel() {
    const worksheet = XLSX.utils.json_to_sheet(data);
    XLSX.utils.sheet_add_aoa(worksheet, [["#", "الاسم", "رقم الهاتف", "رقم التعريف"]], { origin: "A1" });
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "بيانات الأشخاص");
    XLSX.writeFile(workbook, "persons_data.xlsx");
  }

  async function processImage() {
    const fileInput = document.getElementById("uploadImage");
    const file = fileInput.files[0];
    if (!file) {
      alert("يرجى تحميل صورة!");
      return;
    }

    document.getElementById("progressBarContainer").style.display = "block";
    document.getElementById("progressBar").style.width = "0%";
    document.getElementById("progressBar").innerText = "0%";

    const reader = new FileReader();
    reader.onload = async function () {
      const result = await Tesseract.recognize(reader.result, "ara+eng", {
        logger: (m) => {
          if (m.status === "recognizing text") {
            const progress = Math.round(m.progress * 100);
            document.getElementById("progressBar").style.width = `${progress}%`;
            document.getElementById("progressBar").innerText = `${progress}%`;
          }
        }
      });

      const rows = result.data.text.split("\n");

      rows.forEach(row => {
        const columns = row.match(/^(.+?)\s+(\d+)\s+(B0.+)$/); // الاسم ثم رقم الهاتف ثم رقم التعريف
        if (columns) {
          data.push({
            name: columns[1].trim(),
            phone: columns[2].trim(),
            id: columns[3].trim()
          });
        }
      });

      renderTable();
      document.getElementById("progressBarContainer").style.display = "none";
    };
    reader.readAsDataURL(file);
  }

  document.addEventListener("DOMContentLoaded", renderTable);
</script>